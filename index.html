<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>جستجوی تصویری با Gemini و دیجی‌کالا</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 20px;
      direction: rtl;
    }
    .container {
      max-width: 600px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin: auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:disabled {
      background: #aaa;
    }
    pre {
      background: #f9f9f9;
      padding: 10px;
      white-space: pre-wrap;
    }
    .product {
      display: flex;
      align-items: center;
      border-bottom: 1px solid #eee;
      padding: 10px 0;
    }
    .product img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      margin-left: 10px;
      border-radius: 5px;
    }
    #preview {
      max-width: 100%;
      border-radius: 10px;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>جستجوی محصول با تصویر</h2>
  <p>در این کد نمونه سرچ محصول با تصویر از مدل Ai جمنای استفاده شده
    <br>
    برای نمایش محصولات مرتبط با تصویر از Api  دیجی کالا استفاده کردم تا بتونم به خوبی کارکرد این مدل سرچ تصویری ساده رو نمایش بدم
  </p>
  <input type="file" id="imageInput" accept="image/*" />
  <img id="preview" />
  <button id="analyzeBtn">تشخیص و جستجو</button>
  <pre id="keywords"></pre>
  <div id="results"></div>
  <a href="https://github.com/alirezasaddeghi">Alirezasadeghi</a>
</div>

<script>
    // در اینجا هم محل قرار دادن توکن شما هست 
const API_KEY = "ypur-Api-key";
const analyzeBtn = document.getElementById("analyzeBtn");
const imageInput = document.getElementById("imageInput");
const previewImg = document.getElementById("preview");
const keywordsEl = document.getElementById("keywords");
const resultsEl = document.getElementById("results");

imageInput.addEventListener("change", () => {
  if (imageInput.files && imageInput.files[0]) {
    const reader = new FileReader();
    reader.onload = (e) => {
      previewImg.src = e.target.result;
      previewImg.style.display = "block";
    };
    reader.readAsDataURL(imageInput.files[0]);
  }
});

analyzeBtn.addEventListener("click", async () => {
  keywordsEl.textContent = "";
  resultsEl.innerHTML = "";

  if (!imageInput.files.length) {
    keywordsEl.textContent = "لطفاً تصویر انتخاب کنید";
    return;
  }

  analyzeBtn.disabled = true;
  const file = imageInput.files[0];
  const reader = new FileReader();

  reader.onloadend = async function () {
    const base64Image = reader.result.split(",")[1];

    try {
      const aiRes = await fetch(
        // در اینجا Api  مدلی که باهاش کار میکنید رو قرار بدید
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [
              {
                parts: [
                  {
                    text: "لطفاً تصویر زیر را تحلیل کن و بین ۵ تا ۱۰ کلیدواژه دقیق و قابل جستجو به زبان فارسی تولید کن. تمرکز داشته باش روی: نوع کالا، رنگ، جنس، سبک، کاربرد، ویژگی خاص، و برند احتمالی. فقط لیست کلیدواژه‌ها را به‌صورت تکی در هر خط بده."
                  },
                  {
                    inlineData: {
                      mimeType: file.type,
                      data: base64Image,
                    },
                  },
                ],
              },
            ],
          }),
        }
      );

      if (!aiRes.ok) throw new Error("خطا در ارسال تصویر به AI");

      const aiData = await aiRes.json();
      const keywordsText = aiData.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
      if (!keywordsText) throw new Error("مدل AI نتوانست کلیدواژه تولید کند");

      keywordsEl.textContent = keywordsText;

      const firstKeyword = keywordsText.split("\n")[0].trim();
      const searchRes = await fetch(
        //  اینجا میتونید Api  سرچ محصول سایت خودتون و یا پروژه رو قرار بدید برای دمو از دیجی کالا استفاده شده
        `https://api.digikala.com/v1/search/?q=${encodeURIComponent(firstKeyword)}`
      );
      if (!searchRes.ok) throw new Error("خطا در جستجوی دیجی‌کالا");

      const searchData = await searchRes.json();
      const products = searchData.data?.products || [];

      if (!products.length) {
        resultsEl.innerHTML = "<p>محصولی پیدا نشد.</p>";
        return;
      }

      products.forEach(p => {
        const imgUrl = p.images?.main?.url || "";
        const price = p.default_variant?.price?.selling_price || "";
        const title = p.title_fa || "";

        const div = document.createElement("div");
        div.className = "product";
        div.innerHTML = `
          <img src="${imgUrl}" alt="${title}">
          <div>
            <div>${title}</div>
            <div>${price ? price.toLocaleString() + " تومان" : ""}</div>
          </div>
        `;
        resultsEl.appendChild(div);
      });
    } catch (err) {
      keywordsEl.textContent = err.message;
    } finally {
      analyzeBtn.disabled = false;
    }
  };

  reader.readAsDataURL(file);
});
</script>

</body>
</html>
